# Global AnoSH plugins

export ASH_PATH_SHELL_PLUGS="$ASH_ROOT/plugins/$ASH_SHELL"

mkdir -p $ASH_ROOT/plugins
mkdir -p $ASH_ROOT/plugins/bin
mkdir -p $ASH_PATH_SHELL_PLUGS

mkdir -p $ASH_ROOT/user/atuin

# --- Install plugins --- #
# starship
if [ ! -f "$ASH_ROOT/plugins/bin/starship" ] && ! command -v starship &> /dev/null; then
    echo "Installing starship..."
    sh <(curl -sS "https://starship.rs/install.sh") -y --bin-dir "$ASH_ROOT/plugins/bin"
fi
# zoxide
if [ ! -f "$ASH_ROOT/plugins/bin/zoxide" ] && ! command -v zoxide &> /dev/null; then
    echo "Installing zoxide..."
    bash <(curl -sSfL "https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh") --bin-dir "$ASH_ROOT/plugins/bin"
fi
# atuin
if [ ! -f "$ASH_ROOT/plugins/bin/atuin" ] && ! command -v atuin &> /dev/null; then
    echo "Installing atuin..."
    sh <(curl --proto '=https' --tlsv1.2 -LsSf https://github.com/atuinsh/atuin/releases/latest/download/atuin-installer.sh) --no-modify-path
    mv "${HOME}/.atuin/bin/atuin" "$ASH_ROOT/plugins/bin/atuin"
    mv "${HOME}/.atuin/bin/atuin-update" "$ASH_ROOT/plugins/bin/atuin-update"
    rm -rf "${HOME}/.atuin"

    $ASH_ROOT/plugins/bin/atuin import auto
fi

# --- Verify installed plugins --- #
for plug in "starship" "zoxide" "atuin"; do
    ash_trace "common.plugins" "Checking if $plug is installed"
    if [ -f "$ASH_PLUG_BIN/$plug" ] || command -v $plug &> /dev/null; then
        ash_trace "common.plugins" "$plug is installed!"
        ASH_PLUGS+=("$plug")
    fi
done

if [[ ${ASH_PLUGS[@]} =~ "starship" ]]; then
    ash_trace "common.plugins" "Initializing starship configuration"
    export STARSHIP_CONFIG="$ASH_ROOT/user/starship.toml"
    export STARSHIP_CACHE="$ASH_ROOT/user/starship-cache"
fi

if [[ ${ASH_PLUGS[@]} =~ "atuin" ]]; then
    ash_trace "common.plugins" "Initializing atuin configuration"
    export ATUIN_CONFIG_DIR="$ASH_ROOT/user/atuin"
    export ATUIN_CONFIG="$ATUIN_CONFIG_DIR/config.toml"
fi

# --- Copy default config if needed --- #
if [ ! -f "$ASH_ROOT/user/starship.toml" ]; then
    ash_trace "common.plugins" "Copying starship.toml to user dir"
    cp $ASH_INST/plugins/starship.toml $ASH_ROOT/user/starship.toml
fi
if [ ! -f "$ASH_ROOT/user/atuin/config.toml" ]; then
    ash_trace "common.plugins" "Copying starship.toml to user dir"
    cp $ASH_INST/plugins/atuin.toml $ASH_ROOT/user/atuin/config.toml
fi
